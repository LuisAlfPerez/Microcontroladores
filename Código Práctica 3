#include "mcc.h"
#include "stdio.h"
#include "stdlib.h"
#include <xlcd.h>

/*
                         Main application
 */

void main(void)
{
    // Initialize the device
    SYSTEM_Initialize();
    
    // Enable the Global Interrupts
    INTERRUPT_GlobalInterruptEnable();

    // Enable the Peripheral Interrupts
    INTERRUPT_PeripheralInterruptEnable();

    // Disable the Global Interrupts
    //INTERRUPT_GlobalInterruptDisable();

    // Disable the Peripheral Interrupts
    //INTERRUPT_PeripheralInterruptDisable();
    int time;
    float dist;
    TMR1IF = 0;
    
    while (1)
    {
        PORTAbits.RA0 = 1;
        __delay_us(10);
        PORTAbits.RA0 = 0;
        __delay_us(350);
        
        while(PORTBbits.RB7==0); //espera a recibir un pulso positivo
            TMR1_StartTimer(); //Timer empieza 
            TMR1_WriteTimer(0); //Empieza en 0
        while(PORTBbits.RB7==1 && !TMR1IF); //espera a que el pulso caiga 
            time = TMR1_ReadTimer(); //Obtiene la informaci√≥n del Timer
            TMR1_StopTimer(); //Detiene el timer
            
        //dist = (time * 0.1667)/29/2;
        dist = ((time)/29/2)/5.6;
        
        sprintf(buffer, "Distance %.4f cm", dist);
         while(BusyXLCD());
            SetDDRamAddr(0x0);
        while(BusyXLCD());
            putsXLCD((char *) buffer);
            
        __delay_ms(250);
    }
}
